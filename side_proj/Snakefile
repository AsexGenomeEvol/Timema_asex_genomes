import re

timema = ['1_Tdi', '1_Tps',
          '2_Tcm', '2_Tsi',
          '3_Tce', '3_Tms',
          '4_Tbi', '4_Tte',
          '5_Tge', '5_Tpa']

trimmed_reads = []
mapping_indices = []
delly_calls = []
manta_dirs = []
smoove_dirs = []

with open('A_mapping_and_preprocessing/resequencing_samples') as tab :
	tab.readline()
	for textline in tab :
		line = textline.split()
		trimmed_reads.append("data/" + line[1] + "/trimmed_reads/" + line[2])
		mapping_indices.append("data/" + line[1] + "/mapping/" + line[2] + "_to_b3v08.bam.bai")
		delly_calls.append("data/" + line[1] + "/variant_calls/" + line[2] + "/" + line[2] + "_delly.bcf")
		manta_dirs.append("data/" + line[1] + "/variant_calls/" + line[2] + "/" + line[2] + "_manta")
		smoove_dirs.append("data/" + line[1] + "/variant_calls/" + line[2] + "/" + line[2] + "_smoove")

### if environmental variable USE_LOCAL contains anything, it will compute on /scratch/local
cluster_script = os.environ.get("USE_LOCAL")
if cluster_script == None :
	cluster_script = ""
else :
	cluster_script = "scripts/use_local.sh "

#### calling rules, in the end there should I one that does all,
#### but in practice it's useful to be able to call the individual steps

rule trim_all :
	input :
		expand(trimmed_reads)

rule map_all :
	input :
		expand(mapping_indices)

rule delly_all :
	input :
		expand(delly_calls)

rule manta_all :
	input :
		expand(manta_dirs)

rule lumpy_all :
	input :
		expand(smoove_dirs)

#### the rules of individual steps

rule trim_reads :
	threads : 16
	resources : mem=80000000, tmp=150000
	input : "A_mapping_and_preprocessing/Illumina-PE_adapters.fa", "data/{sp}/raw_reads/{sample}"
	output : "data/{sp}/trimmed_reads/{sample}"
	shell : cluster_script + "A_mapping_and_preprocessing/trim_reads.sh {wildcards.sp} {wildcards.sample} {input} {output}"

rule index_genome :
	threads : 1
	resources: mem=20000000, tmp=20000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz"
	output : "data/{sp}/reference/{sp}_b3v08.fasta.gz.bwt"
	shell : cluster_script + "A_mapping_and_preprocessing/index_fa_bwa.sh {input} data/{wildcards.sp}/reference/{wildcards.sp}_b3v08.fasta.gz."

rule map_reads :
	threads : 16
	resources : mem=104857600, tmp=60000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz.bwt", "data/{sp}/trimmed_reads/{sample}"
	output : "data/{sp}/mapping/{sample}_to_b3v08.bam"
	shell :
		cluster_script + "A_mapping_and_preprocessing/map_reads.sh {wildcards.sample} {wildcards.sp} data/{wildcards.sp}/trimmed_reads/{wildcards.sample}/*_R[12]*q.gz data/{wildcards.sp}/reference/{wildcards.sp}_b3v08.fasta.gz.* {output}"

rule index_bam :
	threads : 1
	resources : mem=20000000, tmp=20000
	input : "{bam}.bam"
	output : "{bam}.bam.bai"
	shell : cluster_script + "A_mapping_and_preprocessing/index_bam.sh {input} {output}"

rule filter_bam :
	threads : 1
	resources : mem=20000000, tmp=30000
	input : "data/{sp}/mapping/{sample}_to_b3v08.bam", "data/{sp}/mapping/{sample}_to_b3v08.bam.bai"
	output : "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam"
	shell : cluster_script + "A_mapping_and_preprocessing/filter_reads.sh A_mapping_and_preprocessing/filter_splitreads.py {input} {output}"

rule call_delly :
	threads : 1
<<<<<<< HEAD
<<<<<<< HEAD
	resources : mem=200000000, tmp=50000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz", "data/{sp}/reference/{sp}_b3v08.fasta.gz.fai", "data/{sp}/reference/{sp}_b3v08.fasta.gz.gzi", "data/{sp}/mapping/{sample}_to_b3v08.bam", "data/{sp}/mapping/{sample}_to_b3v08.bam.bai"
=======
	resources : mem=40000000, tmp=50000
=======
	resources : mem=20000000, tmp=50000
>>>>>>> [variant_analysis] reducing overshot computational requirements
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz", "data/{sp}/reference/{sp}_b3v08.fasta.gz.fai", "data/{sp}/reference/{sp}_b3v08.fasta.gz.gzi", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam.bai"
>>>>>>> [variant_analysis] smoove should work now, reducting memory requested for delly, to be tested
	output : "data/{sp}/variant_calls/{sample}/{sample}_delly.bcf"
	shell : cluster_script + "E_structural_variation_calling/delly.sh {input} {output}"

rule call_lumpy :
	threads : 8
	resources : mem=60000000, tmp=50000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz", "data/{sp}/reference/{sp}_b3v08.fasta.gz.fai", "data/{sp}/reference/{sp}_b3v08.fasta.gz.gzi", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam.bai"
	output : directory("data/{sp}/variant_calls/{sample}/{sample}_smoove")
	shell :  cluster_script + "E_structural_variation_calling/smoove.sh {wildcards.sample} {input} {output}"

rule index_fasta :
	threads : 1
	resources : mem=20000000, tmp=10000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz"
	output : "data/{sp}/reference/{sp}_b3v08.fasta.gz.fai", "data/{sp}/reference/{sp}_b3v08.fasta.gz.gzi"
	shell : cluster_script + "A_mapping_and_preprocessing/index_fa_sam.sh {input} {output}"

rule call_manta :
	threads : 32
	resources : mem=200000000, tmp=50000
	input : "data/{sp}/reference/{sp}_b3v08.fasta.gz", "data/{sp}/reference/{sp}_b3v08.fasta.gz.fai", "data/{sp}/reference/{sp}_b3v08.fasta.gz.gzi", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam", "data/{sp}/mapping/{sample}_to_b3v08_mapped_within_scfs.bam.bai"
	output : directory("data/{sp}/variant_calls/{sample}/{sample}_manta")
	shell : cluster_script + "E_structural_variation_calling/manta.sh {input} {output}"
